map $http_accept_language $accept_language {
  ~*^de de;
  ~*^en en;
  default nl;
}

map $cookie_preferredLanguage $preferred_language {
  ~*^(en|de|nl)$ $1;
  default "";
}

# Use cookie preference if set, otherwise use Accept-Language
map $preferred_language $detected_language {
  "" $accept_language;
  default $preferred_language;
}

server {
  listen 80;
  server_name _;

  root /usr/share/nginx/html;
  index index.php index.html;

  # Root - redirect to detected language
  location = / {
    return 302 $scheme://$http_host/$detected_language/;
  }

  # Non-language-prefixed pages - redirect to detected language
  location = /jobs {
    return 302 $scheme://$http_host/$detected_language/jobs;
  }
  location = /reliability {
    return 302 $scheme://$http_host/$detected_language/reliability;
  }
  location = /imprint {
    return 302 $scheme://$http_host/$detected_language/imprint;
  }
  location = /blog {
    return 302 $scheme://$http_host/$detected_language/blog;
  }

  # Static assets - serve directly
  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 30d;
    add_header Cache-Control "public, immutable";
  }

  # PHP handler
  location ~ \.php$ {
    try_files $uri =404;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME /var/www/html$fastcgi_script_name;
    fastcgi_param DOCUMENT_ROOT /var/www/html;
    fastcgi_pass php:9000;
  }

  # Language prefix routing - main pages
  location ~ ^/(en|de|nl)/?$ {
    rewrite ^/([^/]+)/?$ /index.php last;
  }

  # Language prefix routing - subpages (jobs, reliability, imprint)
  location ~ ^/(en|de|nl)/(imprint|jobs|reliability)/?$ {
    rewrite ^/([^/]+)/(.*)$ /$2.php last;
  }

  # Language prefix routing - blog
  location ~ ^/(en|de|nl)/blog {
    rewrite ^/([^/]+)/blog/?$ /blog/index.php last;
    try_files $uri $uri/ /blog/index.php;
  }

  # Default fallback for language-prefixed paths
  location ~ ^/(en|de|nl)/ {
    try_files $uri $uri/ /index.php;
  }
}

